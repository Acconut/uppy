<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Uppy – AWS upload example</title>
    <link href="./uppy.min.css" rel="stylesheet" />
  </head>
  <body>
    <h1>AWS upload example</h1>
    <details open name="uppy">
      <summary>Sign on the server</summary>
      <div id="uppy-sign-on-server"></div>
    </details>
    <details name="uppy">
      <summary>Sign on the client (if WebCrypto is available)</summary>
      <div id="uppy-sign-on-client"></div>
    </details>
    <footer>
      You seeing the simplified example, with a backend that mimicks a
      Companion-like instance. See
      <a href="./withCustomEndpoints.html">the custom endpoint example</a> if
      you need to see how to use one or more custom function for handling
      communication with the backend.
    </footer>
    <noscript>You need JavaScript to run this example.</noscript>
    <script type="module">
      import { Uppy, Dashboard, AwsS3 } from './uppy.min.mjs'
      function onUploadComplete(result) {
        console.log(
          'Upload complete! We’ve uploaded these files:',
          result.successful,
        )
      }
      function onUploadSuccess(file, data) {
        console.log(
          'Upload success! We’ve uploaded this file:',
          file.meta['name'],
        )
      }
      function* serializeSubPart(key, value) {
        if (typeof value !== 'object') {
          yield [key, value]
          return
        }
        if (Array.isArray(value)) {
          for (const val of value) {
            yield* serializeSubPart(`${key}[]`, val)
          }
          return
        }
        for (const [subkey, val] of Object.entries(value)) {
          yield* serializeSubPart(key ? `${key}[${subkey}]` : subkey, val)
        }
      }
      function serialize(data) {
        // If you want to avoid preflight requests, use URL-encoded syntax:
        return new URLSearchParams(serializeSubPart(null, data))
        // If you don't care about additional preflight requests, you can also use:
        // return JSON.stringify(data)
        // You'd also have to add `Content-Type` header with value `application/json`.
      }
      {
        const uppy = new Uppy()
          .use(Dashboard, {
            inline: true,
            target: '#uppy-sign-on-server',
          })
          .use(AwsS3, {
            id: 'myAWSPlugin',
            endpoint: '/',
            async getUploadParameters(file, options) {
              const arrayBuffer = await file.data.arrayBuffer()
              const hashBuffer = await crypto.subtle.digest(
                'SHA-256',
                arrayBuffer,
              )
              const stringifiedHash = String.fromCharCode(
                ...new Uint8Array(hashBuffer),
              )
              const ChecksumSHA256 = window.btoa(stringifiedHash)

              // Send a request to our Express.js signing endpoint.
              const response = await fetch('/s3/sign', {
                method: 'POST',
                headers: {
                  accept: 'application/json',
                },
                body: serialize({
                  filename: file.name,
                  contentType: file.type,
                  ChecksumSHA256,
                }),
                signal: options.signal,
              })

              if (!response.ok)
                throw new Error('Unsuccessful request', { cause: response })

              // Parse the JSON response.
              const data = await response.json()

              // Return an object in the correct shape.
              return {
                method: data.method,
                url: data.url,
                fields: {}, // For presigned PUT uploads, this should be left empty.
                // Provide content type header required by S3
                headers: {
                  'Content-Type': file.type,
                  'x-amz-checksum-sha256': ChecksumSHA256,
                  'x-amz-sdk-checksum-algorithm': 'SHA256',
                },
              }
            },
          })

        uppy.on('complete', onUploadComplete)
        uppy.on('upload-success', onUploadSuccess)
      }
      {
        const uppy = new Uppy()
          .use(Dashboard, {
            inline: true,
            target: '#uppy-sign-on-client',
          })
          .use(AwsS3, {
            id: 'myAWSPlugin',
            endpoint: '/',
            getTemporarySecurityCredentials: typeof crypto?.subtle === 'object',
          })

        uppy.on('complete', onUploadComplete)
        uppy.on('upload-success', onUploadSuccess)
      }
    </script>
  </body>
</html>
